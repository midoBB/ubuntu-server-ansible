[Unit]
Description=Vault Agent
Documentation=https://www.vaultproject.io/docs/agent
Requires=vault.service vault-unseal.service
After=vault.service vault-unseal.service
Wants=network-online.target
After=network-online.target

[Service]
Type=simple
User=vault
Group=vault
# Runtime directory
RuntimeDirectory={{ vault_runtime_dir }}
RuntimeDirectoryMode=0700
Environment=VAULT_SKIP_VERIFY=true
# Execution steps
ExecStartPre=/bin/sh -c 'cat ${CREDENTIALS_DIRECTORY}/approle_role_id > ${RUNTIME_DIRECTORY}/role-id'
ExecStartPre=/bin/sh -c 'cat ${CREDENTIALS_DIRECTORY}/approle_secret_id > ${RUNTIME_DIRECTORY}/secret-id'
# ExecStartPre=/bin/chmod 600 ${RUNTIME_DIRECTORY}/role-id ${RUNTIME_DIRECTORY}/secret-id
ExecStart={{ vault_install_dir }}/vault agent -config={{ vault_config_dir }}/vault-agent.hcl
# ExecStartPost=/bin/chown -R {{ deploy_user_name }}:{{ deploy_user_name }} ${RUNTIME_DIRECTORY}
# ExecStartPost=/bin/chmod -R 700 ${RUNTIME_DIRECTORY}
# Restart policy
Restart=on-failure
RestartSec=5
KillMode=process
KillSignal=SIGINT

# Security settings
# NoNewPrivileges=yes
# PrivateTmp=yes
# ProtectSystem=strict
# ProtectHome=yes
# ProtectKernelTunables=yes
# ProtectKernelModules=yes
# ProtectControlGroups=yes
# RestrictRealtime=yes
# RestrictSUIDSGID=yes
# LockPersonality=yes
# MemoryDenyWriteExecute=yes
# RestrictNamespaces=yes
# SystemCallFilter=@system-service
# SystemCallErrorNumber=EPERM

# Credentials
LoadCredentialEncrypted=approle_role_id:/etc/credstore/approle_role_id
LoadCredentialEncrypted=approle_secret_id:/etc/credstore/approle_secret_id

# Cleanup on stop
ExecStopPost=/bin/rm -f {{ vault_secret_dest_dir }}/role-id {{ vault_secret_dest_dir }}/secret-id {{vault_secret_dest_dir }}/approle_token

[Install]
WantedBy=multi-user.target
